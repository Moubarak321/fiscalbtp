<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FiscalBTP Pro - Accompagnement Fiscal BTP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">   
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <i class="fas fa-hard-hat"></i>
                <span>FiscalBTP Pro</span>
            </div>
            <div class="user-info">
                <button class="notification-btn" onclick="alert('3 nouvelles notifications')">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </button>
                <span class="user-name">Expert Comptable</span>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav>
                <div class="nav-item active" onclick="showSection('dashboard', this)">
                    <i class="fas fa-chart-line"></i>
                    <span>Tableau de bord</span>
                </div>
                <div class="nav-item" onclick="showSection('chantiers', this)">
                    <i class="fas fa-building"></i>
                    <span>Chantiers</span>
                </div>
                <div class="nav-item" onclick="showSection('guidage', this)">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Guidage fiscal</span>
                </div>
                <div class="nav-item" onclick="showSection('alertes', this)">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Alertes</span>
                </div>
                <div class="nav-item" onclick="showSection('documents', this)">
                    <i class="fas fa-folder-open"></i>
                    <span>Documents</span>
                </div>
                <div class="nav-item" onclick="showSection('rapports', this)">
                    <i class="fas fa-file-alt"></i>
                    <span>Rapports</span>
                </div>
                <div class="nav-item" onclick="showSection('parametres', this)">
                    <i class="fas fa-sliders-h"></i>
                    <span>Paramètres fiscaux</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <h1 style="margin-bottom: 2rem;">Tableau de bord</h1>
                
                <div style="display:flex; gap:1rem; align-items:center; margin-bottom:1rem;">
                    <input id="globalSearchInput" type="text" class="form-input" placeholder="Filtrer par chantier, client, type, statut..." style="max-width:350px;">
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="stat-chantiers-actifs">--</div>
                                <div class="stat-label">Chantiers actifs</div>
                            </div>
                            <div class="stat-icon primary">
                                <i class="fas fa-building"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="stat-alertes">--</div>
                                <div class="stat-label">Alertes en cours</div>
                            </div>
                            <div class="stat-icon warning">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="stat-conformite">--%</div>
                                <div class="stat-label">Conformité fiscale</div>
                            </div>
                            <div class="stat-icon success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value">5</div>
                                <div class="stat-label">Échéances 7 jours</div>
                            </div>
                            <div class="stat-icon danger">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i>
                            Actions prioritaires
                        </h2>
                    </div>
                    <div id="actions-prioritaires-container">
                        <div class="alert alert-info">
                            <i class="fas fa-spinner fa-spin"></i>
                            <div>Chargement des actions...</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-clock"></i>
                            Échéances à venir
                        </h2>
                    </div>
                    <div class="table-container">
                        <table id="calendar-table">
                            <thead>
                                <tr>
                                    <th>Chantier</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Montant</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Généré par JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Chantiers Section -->
            <section id="chantiers" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h1>Gestion des chantiers</h1>
                    <button id="openNewChantierBtn" class="btn btn-primary" onclick="openModal('newChantierModal')">
                        <i class="fas fa-plus"></i>
                        Nouveau chantier
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-building"></i>
                            Liste des chantiers
                        </h2>
                        <input id="chantierSearch" type="text" class="form-input" placeholder="Rechercher un chantier..." style="max-width: 300px;">
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom du chantier</th>
                                    <th>Client</th>
                                    <th>CA total</th>
                                    <th>Acomptes</th>
                                    <th>Statut fiscal</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="chantierTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Guidage Section -->
            <section id="guidage" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h1>Guidage fiscal</h1>
                    <select id="guidageChantierSelect" class="form-select" style="max-width: 300px;">
                        <option value="">Sélectionner un chantier...</option>
                        <!-- Rempli par JS -->
                    </select>
                </div>

                <div id="guidage-content" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-clipboard-check"></i>
                                Check-list fiscale - <span id="guidageChantierName"></span>
                            </h2>
                            <div>
                                <span style="margin-right: 1rem;" id="guidageProgressText">Progression: 0%</span>
                                <div class="progress-bar" style="width: 200px; display: inline-block;">
                                    <div id="guidageProgressBar" class="progress-fill" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>

                        <ul class="checklist" id="guidageChecklist">
                            <!-- Check-list générée dynamiquement -->
                        </ul>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-lightbulb"></i>
                                Recommandations & Alertes
                            </h2>
                        </div>
                        <div id="guidageRecommendations" style="padding: 1rem;">
                            <!-- Recommandations générées dynamiquement -->
                        </div>
                    </div>
                </div>

                <div id="guidage-empty" class="card" style="text-align: center; padding: 3rem;">
                    <i class="fas fa-hard-hat" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 1rem;"></i>
                    <p>Veuillez sélectionner un chantier pour accéder au guidage fiscal personnalisé.</p>
                </div>
            </section>

            <!-- Alertes Section -->
            <section id="alertes" class="section">
                <h1 style="margin-bottom: 2rem;">Alertes et notifications</h1>

                <div style="display:flex; gap:1rem; margin-bottom:1rem;">
                    <button class="btn btn-outline" onclick="window.exportAlertesCSV && window.exportAlertesCSV()"><i class="fas fa-file-csv"></i> Exporter Alertes (CSV)</button>
                </div>
                <div class="card" id="alertes-dyn-container">
                    <!-- Alertes dynamiques générées par JS -->
                </div>
                    <div class="card" id="alertes-historique-container" style="margin-top:2rem;">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-history"></i> Historique des alertes et actions</h2>
                        </div>
                        <div id="alertes-historique-list" style="padding:1rem; color:#555;">
                            <!-- Historique généré par JS -->
                        </div>
                    </div>
            </section>

            <!-- Documents Section (New) -->
            <section id="documents" class="section">
                <h1 style="margin-bottom: 2rem;">Documents fiscaux</h1>
                <div class="card">
                    <div style="display:flex; gap:1rem; margin-bottom:1rem;">
                        <button class="btn btn-outline" onclick="window.exportCalendarCSV && window.exportCalendarCSV()"><i class="fas fa-file-csv"></i> Exporter Calendrier (CSV)</button>
                    </div>
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-folder"></i> Mes documents</h2>
                        <button class="btn btn-primary"><i class="fas fa-upload"></i> Importer</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Taille</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Déclaration TVA Janvier.pdf</td>
                                    <td>PDF</td>
                                    <td>15/01/2026</td>
                                    <td>2.4 MB</td>
                                    <td><button class="action-btn"><i class="fas fa-download"></i></button></td>
                                </tr>
                                <tr>
                                    <td>Attestation Urssaf.pdf</td>
                                    <td>PDF</td>
                                    <td>10/01/2026</td>
                                    <td>1.1 MB</td>
                                    <td><button class="action-btn"><i class="fas fa-download"></i></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Rapports Section (New) -->
            <section id="rapports" class="section">
                <h1 style="margin-bottom: 2rem;">Rapports et Analyses</h1>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">1.2M€</div>
                        <div class="stat-label">CA Cumulé 2026</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">240k€</div>
                        <div class="stat-label">TVA Collectée</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Évolution du CA</h2>
                    </div>
                    <div style="height: 200px; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-radius: 8px; color: var(--text-gray);">
                        <i class="fas fa-chart-area" style="font-size: 3rem; margin-right: 1rem;"></i>
                        <span>Graphique d'évolution (Placeholder)</span>
                    </div>
                </div>
            </section>

            <!-- Paramètres Fiscaux Section -->
            <section id="parametres" class="section">
                <h1 style="margin-bottom: 2rem;">Paramètres fiscaux personnalisés</h1>
                <div style="display:flex; gap:1rem; margin-bottom:1rem;">
                    <button class="btn btn-outline" onclick="window.resetCustomRules && window.resetCustomRules()"><i class="fas fa-redo"></i> Réinitialiser par défaut</button>
                    <button class="btn btn-success" onclick="window.loadCustomRulesForm && window.loadCustomRulesForm()"><i class="fas fa-upload"></i> Charger config</button>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-percent"></i> Taux de TVA par nature de chantier</h2>
                    </div>
                    <div style="padding:1rem;">
                        <div class="form-grid-3">
                            <div>
                                <label style="display:block; margin-bottom:0.5rem;"><strong>Neuf (20%)</strong></label>
                                <input id="tva-neuf" type="number" class="form-input" min="0" max="100" step="0.5" placeholder="20">
                                <small>TVA normale pour construction neuve</small>
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:0.5rem;"><strong>Rénovation (10%)</strong></label>
                                <input id="tva-renovation" type="number" class="form-input" min="0" max="100" step="0.5" placeholder="10">
                                <small>TVA intermédiaire</small>
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:0.5rem;"><strong>Rénovation énergétique (5.5%)</strong></label>
                                <input id="tva-renovation-energetique" type="number" class="form-input" min="0" max="100" step="0.5" placeholder="5.5">
                                <small>TVA réduite</small>
                            </div>
                        </div>
                        <button class="btn btn-primary" style="margin-top:1rem;" onclick="window.saveCustomRules && window.saveCustomRules()"><i class="fas fa-save"></i> Enregistrer les taux</button>
                    </div>
                </div>
                <div class="card" style="margin-top:2rem;">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-clipboard-list"></i> Seuils d'alerte</h2>
                    </div>
                    <div style="padding:1rem;">
                        <div class="form-grid-2">
                            <div>
                                <label style="display:block; margin-bottom:0.5rem;"><strong>Budget minimum pour URSSAF (€)</strong></label>
                                <input id="threshold-urssaf" type="number" class="form-input" min="0" step="100" placeholder="5000">
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:0.5rem;"><strong>Taux d'acompte maximum sans alerte (%)</strong></label>
                                <input id="threshold-acompte" type="number" class="form-input" min="0" max="100" step="5" placeholder="30">
                            </div>
                        </div>
                        <button class="btn btn-primary" style="margin-top:1rem;" onclick="window.saveCustomThresholds && window.saveCustomThresholds()"><i class="fas fa-save"></i> Enregistrer les seuils</button>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Modal Nouveau Chantier -->
    <div class="modal" id="newChantierModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="chantierModalTitle">Nouveau Chantier</h2>
                <button class="modal-close" onclick="closeModal('newChantierModal')">&times;</button>
            </div>
            <form id="newChantierForm">
                <div class="form-group">
                    <label>Nom du chantier</label>
                    <input type="text" name="nom" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Client</label>
                    <input type="text" name="client" class="form-input" required>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Type de client</label>
                        <select name="typeClient" class="form-select" required>
                            <option value="prive">Privé (Particulier/Entreprise)</option>
                            <option value="public">Marché Public</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Budget (€)</label>
                        <input type="number" name="budget" class="form-input" required>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Acomptes prévus (%)</label>
                        <input type="number" name="acomptesPourcentage" class="form-input" min="0" max="100" value="30">
                    </div>
                    <div class="form-group">
                        <label>Date de début</label>
                        <input type="date" name="dateDebut" class="form-input" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Nature des travaux</label>
                    <select name="nature" class="form-select" required>
                        <option value="neuf">Construction Neuve (20%)</option>
                        <option value="renovation">Rénovation / Amélioration (10%)</option>
                        <option value="renovation_energetique">Rénovation Énergétique (5.5%)</option>
                        <option value="entretien">Entretien / Réparation (10%)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Rôle de l'entreprise</label>
                    <select name="role" class="form-select" required>
                        <option value="principale">Entreprise Principale</option>
                        <option value="sous-traitant">Sous-traitant</option>
                    </select>
                </div>
                <div style="margin-top: 1.5rem; text-align: right;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('newChantierModal')">Annuler</button>
                    <button type="submit" id="chantierSubmitBtn" class="btn btn-primary">Créer le chantier</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Détails Chantier -->
    <div class="modal" id="chantierDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="chantierDetailsName">Détails du Chantier</h2>
                <button class="modal-close" onclick="closeModal('chantierDetailsModal')">&times;</button>
            </div>
            <div style="padding: 1rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div>
                        <label style="font-weight: bold; display: block; margin-bottom: 0.3rem;">Client</label>
                        <span id="chantierDetailsClient" style="color: #555;">-</span>
                    </div>
                    <div>
                        <label style="font-weight: bold; display: block; margin-bottom: 0.3rem;">Budget</label>
                        <span id="chantierDetailsBudget" style="color: #555;">-</span>
                    </div>
                    <div>
                        <label style="font-weight: bold; display: block; margin-bottom: 0.3rem;">Nature</label>
                        <span id="chantierDetailsNature" style="color: #555;">-</span>
                    </div>
                    <div>
                        <label style="font-weight: bold; display: block; margin-bottom: 0.3rem;">Rôle</label>
                        <span id="chantierDetailsRole" style="color: #555;">-</span>
                    </div>
                    <div>
                        <label style="font-weight: bold; display: block; margin-bottom: 0.3rem;">Statut Fiscal</label>
                        <span id="chantierDetailsStatut" class="badge">-</span>
                    </div>
                </div>
                
                <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
                    <button class="btn btn-outline" onclick="closeModal('chantierDetailsModal')">Fermer</button>
                    <button class="btn btn-primary" onclick="closeModal('chantierDetailsModal'); showSection('guidage');">
                        <i class="fas fa-clipboard-check"></i> Aller au Guidage
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts chargés séquentiellement pour compatibilité locale (sans module ES6) -->
    <script src="js/modules/fiscalRules.js"></script>
    <script src="js/modules/customRules.js"></script>
    <script src="js/modules/chantiers.js"></script>
    <script src="js/modules/ui.js"></script>
    <script src="js/modules/dashboard.js"></script>
    <script src="js/modules/calendar.js"></script>
    <script src="js/main.js"></script>
</body>
</html>
